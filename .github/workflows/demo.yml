# SPDX-License-Identifier: PMPL-1.0-or-later
# SPDX-FileCopyrightText: 2024 My-newsroom Contributors
#
# Demo workflow: Run the complete demo showcasing all dialect components

name: Demo

on:
  push:
    branches: ["main"]
    paths:
      - "examples/**"
      - "solo-compiler/**"
      - "src/**"
      - "test/**"
      - "Project.toml"
  pull_request:
    branches: ["main"]
    paths:
      - "examples/**"
      - "solo-compiler/**"
      - "src/**"
      - "test/**"
      - "Project.toml"
  workflow_dispatch:

jobs:
  belief-fusion:
    name: Belief Fusion (Julia)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: "1.9"

      - name: Cache Julia packages
        uses: actions/cache@v5
        with:
          path: ~/.julia
          key: julia-${{ runner.os }}-${{ hashFiles('Project.toml') }}
          restore-keys: |
            julia-${{ runner.os }}-

      - name: Install dependencies
        run: julia --project=. -e 'using Pkg; Pkg.instantiate()'

      - name: Run belief fusion example
        run: |
          echo "========================================"
          echo "  Dempster-Shafer Belief Fusion Demo"
          echo "========================================"
          julia --project=. examples/julia/basic_fusion.jl

      - name: Run belief fusion tests
        run: |
          echo "========================================"
          echo "  Running MyNewsroom.jl Test Suite"
          echo "========================================"
          julia --project=. -e 'using Pkg; Pkg.test()'

  solo-lexer:
    name: Solo Lexer Tests (Rust)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: solo-compiler
    steps:
      - uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-action@stable
        with:
          components: clippy

      - name: Cache Cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            solo-compiler/target
          key: cargo-${{ runner.os }}-${{ hashFiles('solo-compiler/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-

      - name: Build Solo compiler
        run: |
          echo "========================================"
          echo "  Building Solo Dialect Compiler"
          echo "========================================"
          cargo build --verbose

      - name: Run lexer tests
        run: |
          echo "========================================"
          echo "  Running Solo Lexer Test Suite"
          echo "========================================"
          cargo test --verbose -- --nocapture

      - name: Check example files
        run: |
          echo "========================================"
          echo "  Checking Solo Example Files"
          echo "========================================"
          cargo run --release -- check ../examples/solo/hello_world.solo || echo "Parser not yet complete - lexer tests passed"
          cargo run --release -- check ../examples/solo/belief_example.solo || echo "Parser not yet complete - lexer tests passed"

  me-playground:
    name: Me Playground (HTML)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Validate playground exists
        run: |
          echo "========================================"
          echo "  Me Dialect Playground Validation"
          echo "========================================"
          test -f examples/me/playground.html || (echo "ERROR: playground.html not found" && exit 1)
          echo "✓ Playground file exists"

      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Validate HTML structure
        run: |
          echo "Validating HTML structure..."
          deno eval "
          const html = await Deno.readTextFile('examples/me/playground.html');

          // Check for required elements
          const checks = [
            [/<html\s+lang=\"en\">/i, 'HTML lang attribute'],
            [/<meta\s+charset=\"UTF-8\">/i, 'UTF-8 charset'],
            [/<title>.*Me.*Playground.*<\/title>/i, 'Title with Me Playground'],
            [/<textarea\s+id=\"code\"/i, 'Code editor textarea'],
            [/<div\s+id=\"output\"/i, 'Output div'],
            [/function\s+runCode\(\)/i, 'runCode function'],
            [/function\s+loadExample\(/i, 'loadExample function'],
            [/examples\s*=\s*{/i, 'Examples object'],
            [/belief\s+.*confidence/i, 'Belief syntax in examples'],
            [/Dempster/i, 'Dempster-Shafer reference'],
          ];

          let passed = 0;
          let failed = 0;

          for (const [pattern, name] of checks) {
            if (pattern.test(html)) {
              console.log('✓', name);
              passed++;
            } else {
              console.log('✗', name, '- MISSING');
              failed++;
            }
          }

          console.log();
          console.log('='.repeat(40));
          console.log('Passed:', passed, '/', checks.length);

          if (failed > 0) {
            Deno.exit(1);
          }
          "

      - name: List playground features
        run: |
          echo "========================================"
          echo "  Me Playground Features"
          echo "========================================"
          echo ""
          echo "Available example programs:"
          deno eval "
          const html = await Deno.readTextFile('examples/me/playground.html');
          const examples = html.match(/loadExample\('(\w+)'\)/g) || [];
          examples.forEach((e, i) => {
            const name = e.match(/loadExample\('(\w+)'\)/)[1];
            console.log('  ' + (i + 1) + '. ' + name.charAt(0).toUpperCase() + name.slice(1));
          });
          "
          echo ""
          echo "Instructions:"
          echo "  1. Open examples/me/playground.html in a browser"
          echo "  2. Write Me dialect code in the editor"
          echo "  3. Click 'Run Code' to execute"
          echo "  4. Try the example programs to learn the syntax"
          echo ""
          echo "Features:"
          echo "  - Epistemic belief state declarations"
          echo "  - Dempster-Shafer belief fusion"
          echo "  - Bayesian updates with evidence"
          echo "  - Trust network propagation"
          echo "  - Shareable code URLs"

  summary:
    name: Demo Summary
    runs-on: ubuntu-latest
    needs: [belief-fusion, solo-lexer, me-playground]
    steps:
      - name: Print summary
        run: |
          echo ""
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║           MY-NEWSROOM DEMO COMPLETED SUCCESSFULLY          ║"
          echo "╠════════════════════════════════════════════════════════════╣"
          echo "║                                                            ║"
          echo "║  ✓ Belief Fusion Example (Julia)                           ║"
          echo "║    - Dempster-Shafer theory demonstration                  ║"
          echo "║    - Multi-source evidence fusion                          ║"
          echo "║    - Comprehensive test suite passed                       ║"
          echo "║                                                            ║"
          echo "║  ✓ Solo Lexer Tests (Rust)                                 ║"
          echo "║    - Affine type system lexer                              ║"
          echo "║    - Epistemic keywords recognized                         ║"
          echo "║    - All embedded tests passed                             ║"
          echo "║                                                            ║"
          echo "║  ✓ Me Playground (HTML)                                    ║"
          echo "║    - Interactive browser-based environment                 ║"
          echo "║    - 5 example programs included                           ║"
          echo "║    - Belief fusion simulation ready                        ║"
          echo "║                                                            ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "To run locally:"
          echo "  julia --project=. examples/julia/basic_fusion.jl"
          echo "  cd solo-compiler && cargo test"
          echo "  open examples/me/playground.html"
